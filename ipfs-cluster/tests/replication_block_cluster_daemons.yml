name: Replication block cluster service
config:
  nodes: 5
  selector: app=ipfs-cluster
  times: 2
  expected:
      successes: 4 # 1 for each iteration (to start)
      failures: 0
      timeouts: 0
steps:
  - name: add random stuff to ipfs
    on_node: 1
    cmd: head -c 100 /dev/urandom | base64 | ipfs add -q
    outputs:
    - line: 0
      save_to: HASH
  - name: add random stuff to cluster with replication
    on_node: 1
    cmd: ipfs-cluster-ctl pin add -r 3 $HASH && sleep 5
  - name: block ipfs daemon in original pod
    on_node: 1
    cmd: killall -STOP ipfs-cluster-service && sleep 15
  - name: block ipfs daemon in random pod
    on_node: 2
    cmd: killall -STOP ipfs-cluster-service && sleep 15
  - name: check that random stuff is repinned with correct replication factor
    on_node: 3
    cmd: ipfs-cluster-ctl --enc json status $HASH | jq -r '.peer_map | .[].status' | sort | uniq -c | sed 's/^ *//'
    assertions:
      - line: 0
        should_be_equal_to: "3 pinned"
      - line: 1
        should_be_equal_to: "3 remote"
  - name: restart daemon to restore state
    on_node: 1
    end_node: 2
    cmd: killall -CONT ipfs-cluster-service
